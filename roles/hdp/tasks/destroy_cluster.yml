# Destroy the cluster

- name: WARNING, all data will be lost. Type CTRL-C to stop the process
  wait_for:
    timeout: 10
  tags: clean

- name: stop the services
  uri:
    url: http://localhost:8080/api/v1/clusters/{{ hdp.cluster.name }}/services
    method: PUT
    user: admin
    password: "{{ hdp.cluster.password }}"
    body: '{"RequestInfo":{"context":"Stopping services"},"Body":{"ServiceInfo":{"state":"INSTALLED"}}}'
    force_basic_auth: yes
    status_code: 200,202
    body_format: raw
    headers:
      X-Requested-By: "ambari"
  ignore_errors: true
  tags: clean
  
- name: wait for services to stop
  wait_for:
    msg: "Checking {{ item.key }}"
    port: "{{ item.value }}"
    state: stopped
    host: "{{ inventory_hostname }}"
    timeout: 300
  with_dict: "{{ hdp.cluster.ports }}"
  tags: clean

- name: stop ambari
  service:
    name: "{{ item }}"
    state: stopped
  become: true
  with_items:
    - ambari-server
    - ambari-agent
  ignore_errors: true
  tags: clean

- name: drop Hive database
  postgresql_db:
    name: hive
    state: absent
  become: true
  become_user: postgres
  tags: clean

- name: drop Ranger database
  postgresql_db:
    name: ranger
    state: absent
  become: true
  become_user: postgres
  tags: clean

- name: drop Ambari database
  postgresql_db:
    name: ambari
    state: absent
  become: true
  become_user: postgres
  tags: clean

- name: cleanup /opt/ambari
  file:
    path: /opt/ambari/
    state: absent
  become: true
  tags: clean

# to be sure to cleanup Ambari's cache and data
- name: uninstall Ambari
  yum:
    name: "{{item }}"
    state: absent
  become: true
  with_items:
    - ambari-server
    - ambari-agent
  tags: clean

- name: cleanup keytabs
  file:
    path: /etc/security/keytabs/
    state: absent
  become: true
  tags: clean

- name: destroy Kerberos database
  shell: kdb5_util destroy -f
  args:
    removes: /var/kerberos/krb5kdc/principal
  become: true
  tags: clean

- name: cleanup hdfs data and solr
  file:
    path: "{{ item }}/"
    state: absent
  become: true
  with_items:
    - /hadoop
    - /opt/ambari_infra_solr/data
  tags: clean

- name: cleanup other data
  file:
    path: "/var/lib/{{ item }}/"
    state: absent
  become: true
  with_items:
    - ambari-server
    - ambari-agent
    - hadoop-hdfs
    - hadoop-mapreduce
    - hadoop-yarn
    - hive
    - hive2
    - ranger
    - zookeeper
  tags: clean

- name: cleanup logs
  file:
    path: "/var/log/{{ item }}/"
    state: absent
  become: true
  with_items:
    - ambari-server
    - ambari-agent
    - ranger
    - hbase
    - hadoop
    - hadoop-yarn
    - hadoop-mapreduce
    - hadoop-hdfs
    - hive2
    - ambari-infra-solr
    - zookeeper
    - hive-hcatalog
  tags: clean


- name: cleanup /tmp
  shell: rm -fr /tmp/Jetty* /tmp/krb* /tmp/ambari* /tmp/hadoop* /tmp/hsperfdata* /tmp/hbase* /tmp/hive* 
  args:
    warn: false
  become: true
  tags: clean

- name: remove users and groups
  user:
    name: "{{ item }}"
    state: absent
  become: true
  with_items:
    - infra-solr
    - tez
    - hcat
    - ranger
    - hive
    - hbase
    - mapred
    - hdfs
    - yarn
    - zookeeper
    - ambari-qa
  when: false
  tags: clean

- debug:
    msg: IT IS RECOMMENDED TO REBOOT SERVER NOW

