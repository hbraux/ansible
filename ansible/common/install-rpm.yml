- name: installation of {{ install.module }}-{{ install.version }}
  debug:
    msg: install={{ install }}
    verbosity: 1
  
- set_fact:
    archive: "{{ install.module }}-{{ install.version }}{{ install.build }}.rpm"

- name: check if {{ archive }} is in {{ global.localhost.cache }}
  stat:
    path: "{{ global.localhost.cache }}/{{ archive }}"
  register: f
  delegate_to: localhost

- name: download {{ archive }} from {{ install.url }}
  get_url:
    url: "{{ install.url }}/{{ archive }}"
    dest: "{{ global.localhost.cache }}"
  environment:
      http_proxy: "{{ global.localhost.http_proxy }}"
  when: not f.stat.exists
  delegate_to: localhost

- name: upload {{ archive }} to {{ inventory_hostname }} 
  copy:
    src: "{{ global.localhost.cache }}/{{ archive }}"
    dest: "{{ install.path.tmp }}/{{ archive }}"
  
- name: yum install {{ archive }}
  yum:
    name: "{{ install.path.tmp }}/{{ archive }}"
    state: present
  register: is_installed

- name: configure {{ install.module }}
  template:
    src: "{{ item }}.j2"
    dest: "{{ install.path.cfg }}/{{ item }}"
  with_items: "{{ install.cfg }}"
  when: install.cfg is defined

- name: start services
  service: name="{{ item }}" state=started enabled=yes
  with_items: "{{ install.services }}"
  when: install.services is defined
