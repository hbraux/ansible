# generic script to install an Apache TAR package 

- name: installation of {{ install.module }}-{{ install.version }}
  set_fact:
    dummyvar: 0
    
- set_fact:
    url: "{{ mirror.apache }}/{{ install.file | dirname }}"
    archive: "{{ install.file | basename }}"
    binpath: "{{ root.bin }}/{{ install.bindir }}"
  when: install.file is defined

- set_fact:
    url: "{{ mirror.apache }}/{{ install.module }}/{{ install.module }}-{{ install.version }}"
    archive: "{{ install.module }}-{{ install.version }}.tar.gz"
    binpath: "{{ path.bin }}"
  when: install.file is not defined

- name: create group {{ install.group }}
  group:
    name: "{{ install.group }}"
    state: present

- name: create user {{ install.user }}
  user:
    name: "{{ install.user }}"
    group: "{{ install.group }}"
    
- name: create data directory {{ path.data }}
  file:
    path: "{{ path.data }}"
    owner: "{{ install.user }}"
    group: "{{ install.group }}"
    state: directory
  
- name: create log directory {{ path.log }}
  file:
    path: "{{ path.log }}"
    owner: "{{ install.user }}"
    group: "{{ install.group }}"
    state: directory
    
- name: create config directory {{ path.cfg }}
  file:
    path: "{{ path.cfg }}"
    owner: "{{ install.user }}"
    group: "{{ install.group }}"
    state: directory
  when: install.configuration is defined
  
- name: check if {{ archive }} is in {{ cache.local }}
  stat:
    path: "{{ cache.local }}/{{ archive }}"
  register: f
  delegate_to: localhost
  
- name: download {{ archive }} from {{ url }}
  get_url:
    url: "{{ url }}/{{ archive }}"
    dest: "{{ cache.local }}"
  environment: "{{proxy_env}}"
  when: not f.stat.exists 
  delegate_to: localhost

- name: unarchive {{ archive }}
  unarchive:
    src: "{{ cache.local }}/{{ archive }}"
    dest: /opt
    owner: "{{ install.user }}"
    group: "{{ install.group }}"
                          
- name: create link {{ root.bin }}/{{ install.module }} to {{ binpath }}
  file:
    src: "{{ binpath }}"
    dest: "{{ root.bin }}/{{ install.module }}"
    state: link

- name: configure {{ install.module }}
  template:
    src: "{{ item }}.j2"
    dest: "{{ path.cfg }}/{{ item }}"
    owner: "{{ install.user }}"
    group: "{{ install.group }}"
  with_items: "{{ install.configuration }}"
  when: install.configuration is defined
  
- name: install data files
  template:
    src: "{{ item }}.j2"
    dest: "{{ path.data }}/{{ item }}"
    owner: "{{ install.user }}"
    group: "{{ install.group }}"
  with_items: "{{ install.datafiles }}"
  when: install.datafiles is defined
  
- name: install systemd scripts
  template:
    src: "{{ item }}-service.j2"
    dest: /etc/systemd/system/{{ item }}.service
  with_items: "{{ install.services }}"
  when: install.services is defined

- name: start services
  service: name="{{ item }}" state=started enabled=yes
  with_items: "{{ install.services }}"
  when: install.services is defined
